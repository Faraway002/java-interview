# 基于知识图谱和认知诊断的在线教育平台

## 项目简介

本项目是实验室项目，为本院学生开发，学生在本系统做题，系统为其进行认知诊断，然后基于知识图谱与其覆盖的知识点做资源推荐，包括错题推荐，课件推荐，慕课推荐等。学生还可以在学习的过程中提出学习问题，类似于知乎，其他学生和老师都可以进行回答。

**相关技术**：SpringBoot + MySQL + Redis + MyBatis-Plus + Shiro

**个人职责**：

- 权限控制模块开发，使用 Shiro 进行权限管理。
- 试卷模块开发，设计算法评判选择题、填空题、判断题以及主观题，支持选择题选项打乱顺序，主观题交由教师评判。
- 问答模块开发，老师和学生都可进行回答，还可以上传附件回答。
- Python 算法整合，使用 RPC 远程调用 Python 实现的认知诊断，推荐等人工智能算法。

## 实现要点

### 权限模块开发

* 自定义三个 Shiro 的 Realm，分别是管理员、教师以及学生。

  本项目不包含注册功能，由管理员统一在后台导入教师和学生。因此在登入时需要判断登入类型，代码中使用了一个枚举类型定义登入类型，并且重写 Shiro 的 Token，加入登入类型标识。

  在获取 Realm 信息时，通过数据库查询数据，设置盐（使用双重 MD5 加密）。

  在获取 Realm 权限时，不进行缓存，而是直接从数据库中查询，保证权限的及时更新。

* 自定义认证流程，获取 Token，然后获取之前自定义的登入类型，根据类型获取 Realm，使用 Shiro 的单 Realm 验证方法，传入自定义的 Realm。

  认证成功后将当前登入用户交给 Shiro 管理的 Session，Session 连接了 Redis，同时还利用 Spring 的 Cache 模块将当前登入用户保存到 Redis。

  在 Python 算法端就可以通过读 Redis 的信息获取当前登入的用户，然后为其做认知诊断和推荐。

* 自定义 Redis 实现的 SessionDAO，使用 Redis 缓存可以加快对 Session 信息的读取。

* 自定义权限验证失败后的 Shiro Filter，重定向到错误 403 页面。

### 试卷模块开发

试卷表和各种题型表关联，导入的题库直接加到题型表，教师组卷时可以从题型表里选，也可以加新题，组完卷后在关联表中会生成关联记录。

学生开始做题时，使用 Redis 加一个过期时间的锁，锁住当前学生，除了能够做当前已经开始的试卷之外，不能做其他试卷，做完试卷以后提前清除 key，或者倒计时结束后清除 key，然后在学生试卷关联表中添加一个结束标记，因为学生不能重复做同一套试卷，但是可以查看已经做过的试卷。

判定时，本卷的每题作答使用 `-` 连接，而每题的答案由 `题目id_题目类型_用户选择` 连接，比如一个试卷 2 道选择题，那么整个答案的字符字符串可能为：`10001_1_A-10003_1_B`；如果是判断题，则题目类型是 2，用户选择的答案处应该是 Y 或 N；如果是主观题，则题目类型是 3，但是不对它进行评判；如果是填空题，则类型有多种，具体看题目类型，需要多个 `_` 连接。

选择题打乱选项顺序可以由前端或后端实现，最开始是后端实现：即打乱以后直接修改数据库。

单空填空题的类型分为：

* 答案只有一个固定的，类型为 4，直接和数据库里记录的单个答案进行比对
* 答案有多个，任意一个都行的，类型为 5，这时数据库里存储的答案是以 `,` 分隔的，直接拿出答案，使用 split，一一比对。

多空填空题是比较难实现的，一般有以下几种类型：

* 每空之间没有关系的，即每个空和答案是一一对应的关系（类型为 6）。

  这种题目和 5 类型类似，这时数据库里存储的答案也是以 `,` 分隔的，直接分割，每一空进行比对

* 每空之间是并列关系的，即答案填到题干的任何一个空上都行。

  类型也是 6，**排序**之后分割匹配。

* 每空有多个答案的，即答案有多种表述方式，任何一个表述方式都对。

  类型为 7，每一空的多个答案以 `,` 分隔，整个题的多个答案以 `;` 分隔。

  先以 `;` 分隔后，对于每一个元素，再以 `;` 分隔，判断当前空是否在其中。

不支持模糊匹配，只支持全字匹配。

### 问答模块开发

问答模块的亮点在于需要在后台根据文本相似度计算公式（SimHash）保存相似的回答到数据库中，而这个计算时间是非常长的，因此为了给用户良好的体验，使用了线程池去执行这个任务。

线程池参数：

1. 核心线程数为 2
2. 最大线程数为 10
3. 其他线程存活时间 1000 ms
4. 使用阻塞队列作为工作队列
5. 线程工厂，简单的把每个线程的名字设置为寻找相似回答线程
6. 拒绝策略设置 `DiscardOldestPolicy`。

### 整合 Python 算法

RestTemplate

## 细节

### Web 日志

AOP 实现，切入点定义为所有的 `Controller`，Before 通知通过原生的 `HttpServletRequest` 获取 URL，请求方式、请求者的 IP 地址以及各个请求参数。使用到了 SpringMVC 的一个工具类 `RequestContextHolder`来获取。

AfterReturning 通知，直接输出返回的内容。

### 分页

分页使用了 PageHelper，然后为了前端，自己封装了一个 `PageInfo`，增加了一些信息。

### 事务管理

使用了 AOP 进行全局事务管理，免去了繁琐的 `@Transactional`。使用了 `TransactionInterceptor` 进行事务拦截，通过方法名有选择的拦截。

对于非查询的修改方法，事务的传播规则设置为 `REQUIRED`，即如果不存在，则创建一个新的事务。

对于查询类的方法，则设置为 `SUPPORTS`，当前没有事务，则以非事务方式执行。

### Redis 配置

key 采用 Spring 的 `StringRedisSerializer`，Value 采取 `GenericJackson2JsonRedisSerializer`，也就是 JSON 的序列化器。

key 的生成规则：`类名 + 方法名 + 所有参数`

### 表设计

admin 和 admin_permission 进行权限关联

student teacher

quiz 保存试卷基本信息，quiz_choice_question 保存试卷和选择题关联信息，quiz_blank_question 保存填空题关联，...
