# MySQL 的 B+ 树索引

在正式介绍索引之前，我们需要了解一下没有索引的时候是怎么查找记录的。

* 假设目前表中的记录比较少，所有的记录都可以被存放到一个页中，在查找记录的时候可以根据搜索条件的不同分为两种情况：
  * 以主键为搜索条件：此时可以使用页中的页目录通过二分查找加快查找。
  * 以其他列为搜素条件：由于其他列不是主键，因此不存在页目录，也就不能加快查找。
* 假设记录很多，需要很多页才能装下，这时首先需要定位列所在的页，然后在页内查找。

没有索引的情况下，查找是相当耗时的。

## 索引的简单方案

我们可以效仿页目录，为快速定位记录所在的数据页而建立一个别的目录，这个目录必须实现：

* 下一个数据页中用户记录的主键值必须大于上一个页中用户记录的主键值。
* 给所有的页建立一个目录项。

示意图如下：

![image-20220414154056115](https://cdn.jsdelivr.net/gh/Faraway002/typora/images/image-20220414154056115.png)

> 页号不一定是连续的，也不要求是连续的，它们可以通过 File Header 的指针连接成双向链表。

以页 28 为例，它对应目录项2 ，这个目录项中包含着该页的页号 28 以及该页中用户记录的最小主键值 5。比方说我们想找主键值为 20 的记录，具体查找过程分两步：

* 先从目录项中根据二分法快速确定出主键值为 20 的记录在目录项 3 中（因为 12 < 20 < 209），它对应的页是页 9。
* 再根据前边说的在页中查找记录的方式去页 9 中定位具体的记录。

这样一来，我们的一个简易索引就完成了，实际系统中的索引要比这复杂得多，我们说明这样一个索引方案的目的是为了能够理解索引的思想和作用。

## InnoDB 中的索引方案

我们的简易索引有几个问题：

1. InnoDB 是使用页来作为管理存储空间的基本单位，也就是最多能保证 16KB 的连续存储空间，而随着表中记录数量的增多，需要非常大的连续的存储空间才能把所有的目录项都放下，这对记录数量非常多的表是不现实的。

   > 这个问题很像操作系统中的分页，页表过大的问题，当然，操作系统的解决方式是多级页表，InnoDB 里是不是也是这样处理的呢？请继续往下看。

2. 我们时常会对记录进行增删，假设我们把页 28 中的记录都删除了， 页 28 也就没有存在的必要了，那意味着目录项 2 也就没有存在的必要了，这就需要把 目录项 2 后的目录项都向前移动一下，这种牵一发而动全身的设计不是什么好主意。

InnoDB 采用了 B+ 树作为索引的数据结构，具体来说，B+ 树索引中最下层的叶子节点存储真实用户记录，而上层的所有其他非叶子节点都是索引节点。

在索引节点中，行格式中 `record_type` 标志位为 1，表示是 B+ 树的非叶子节点；而在叶子节点中，`record_type` 的值为 0。

