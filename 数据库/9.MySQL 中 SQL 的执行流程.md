## 更新过程与 MySQL 日志

MySQL 更新过程和 MySQL 查询过程类似，也会将流程走一遍。不一样的是：**更新流程还涉及两个重要的日志模块：redo log（重做日志）和 binlog（归档日志）**。

### redo log（重做日志）

**redo log 是 InnoDB 引擎特有的日志**。redo log 是物理日志，记录的是**在某个数据页上做了什么修改**。

**redo log 是基于 WAL 技术**。WAL 的全称是 **Write-Ahead Logging**，它的关键点就是**先写日志，再写磁盘**。

具体来说，当有一条记录需要更新的时候，InnoDB 引擎就会先把记录写到 redo log 里，并更新内存，这个时候更新就算完成了。同时，**InnoDB 引擎会在适当的时候，将这个操作记录更新到磁盘里面**，而这个更新往往是在系统比较空闲的时候做。

InnoDB 的 redo log 是**固定大小**的，比如可以配置为一组 4 个文件，每个文件的大小是 1GB，那么总共就可以记录 4GB 的操作。**从头开始写，写到末尾就又回到开头循环写**。示意图如下：

![image-20220401211350818](https://cdn.jsdelivr.net/gh/Faraway002/typora/images/image-20220401211350818.png)

**有了 redo log，InnoDB 就可以保证即使数据库发生异常重启，之前提交的记录都不会丢失**，这个能力称为 **crash-safe**。

### bin log（归档日志）

binlog 是逻辑日志，**记录的是这个语句的原始逻辑**。

binlog 是**可以追加写入**的，即写到一定大小后会切换到下一个，并**不会覆盖以前的日志**。

**binlog 是 MySQL 的 Server 层实现的，所有引擎都可以使用**。

当 `sync_binlog` 这个参数设置成 1 的时候，表示每次事务的 binlog 都持久化到磁盘。

### 对比

这两种日志有以下三点不同。

- redo log 是 InnoDB 引擎特有的；binlog 是 MySQL 的 Server 层实现的，所有引擎都可以使用。
- redo log 是物理日志，记录的是在某个数据页上做了什么修改；binlog 是逻辑日志，记录的是这个语句的原始逻辑，比如“给 ID=2 这一行的 c 字段加 1 ”。
- redo log 是循环写的，空间固定会用完；binlog 是可以追加写入的。“追加写”是指 binlog 文件写到一定大小后会切换到下一个，并不会覆盖以前的日志。

