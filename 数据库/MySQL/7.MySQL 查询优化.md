#  MySQL 查询优化

## 1. MySQL 基于成本的优化

在 MySQL 中一条查询语句的执行成本是由这两个方面组成的：

* **I/O 成本**：存储引擎都是将数据和索引都存储到磁盘上的，当我们想查询表中的记录时，需要先把数据或者索引加载到内存中然后再操作。
* **CPU 成本**：读取以及检测记录是否满足对应的搜索条件、对结果集进行排序等这些操作损耗的时间称之为 CPU 成本。

对于 InnoDB 存储引擎来说，页是磁盘和内存之间交互的基本单位，**MySQL 规定读取一个页面花费的成本默认是 1.0**，**读取以及检测一条记录是否符合搜索条件的成本默认是 0.2**。1.0、0.2 这些数字称之为**成本常数**，这两个成本常数我们最常用到，其余的成本常数我们之后再说。

### 1.1 单表查询的成本

我们还是需要一个表作为例子，就拿前两章的单表访问方法中的例子拿过来吧：

```mysql
CREATE TABLE single_table (
    id INT NOT NULL AUTO_INCREMENT,
    key1 VARCHAR(100),
    key2 INT,
    key3 VARCHAR(100),
    key_part1 VARCHAR(100),
    key_part2 VARCHAR(100),
    key_part3 VARCHAR(100),
    common_field VARCHAR(100),
    PRIMARY KEY (id),
    KEY idx_key1 (key1),
    UNIQUE KEY idx_key2 (key2),
    KEY idx_key3 (key3),
    KEY idx_key_part(key_part1, key_part2, key_part3)
) Engine=InnoDB CHARSET=utf8;
```

我们假设这表里有 10000 条数据，除 id 列自增外其余的列都是插入的随机值。

#### 1.1.1 基于成本的优化步骤

在一条单表查询语句真正执行之前，**MySQL 的查询优化器会找出执行该语句所有可能使用的方案，对比之后找出成本最低的方案，这个成本最低的方案就是所谓的执行计划，之后才会调用存储引擎提供的接口真正的执行查询**，这个过程总结一下就是这样:

1. 根据搜索条件，找出所有可能使用的索引、
2. 计算全表扫描的代价
3. 计算使用不同索引执行查询的代价
4. 对比各种执行方案的代价，找出成本最低的那一个

以下面这条查询语句为例：

```mysql
SELECT * FROM single_table 
WHERE key1 IN ('a', 'b', 'c') 
AND key2 > 10 
AND key2 < 1000 
AND key3 > key2 
AND key_part1 LIKE '%hello%' 
AND common_field = '123';
```

下面按照上面介绍的步骤一一分析：

1. 根据搜索条件，找出所有可能使用的索引。

   

2. 