# MySQL 日志

MySQL 日志 主要包括错误日志、查询日志、慢查询日志、事务日志、二进制日志几大类。

其中，比较重要的还要属二进制日志 binlog（归档日志）、事务日志 redo log（重做日志）以及 undo log（回滚日志）。

## redo log

redo log 又称**重做日志**，是 InnoDB 存储引擎独有的，它让 MySQL 拥有了崩溃恢复能力，**它记录的是数据页的物理修改**。

比如 MySQL 实例挂了或宕机了，重启时，InnoDB 存储引擎会使用 redo log 恢复数据，保证数据的持久性与完整性：

![image-20220513104333243](https://fastly.jsdelivr.net/gh/Faraway002/typora/images/image-20220513104333243.png)

我们知道，MySQL 中数据存储是以页为单位的，**查询一条记录时，会从硬盘把一页的数据加载出来，放入到 Buffer Pool 中**，后续的查询都是先从 Buffer Pool 中找，没有命中再去硬盘加载，减少硬盘 I/O 开销，提升性能。

事实上，更新表数据的时候也是如此，如果发现 Buffer Pool 里存在要更新的数据，就直接在 Buffer Pool 里更新，然后会把`在某个数据页上做了什么修改`这条记录写到重做日志缓存（redo log buffer）里，接着刷盘到 redo log 文件里：

![image-20220513104809791](https://fastly.jsdelivr.net/gh/Faraway002/typora/images/image-20220513104809791.png)

理想情况下，事务一提交就会进行刷盘操作，但实际上，刷盘的时机是根据策略来进行的。

### 刷盘时机

InnoDB 存储引擎为 redo log 的刷盘策略提供了 `innodb_flush_log_at_trx_commit` 参数，它支持三种策略：

- 0：设置为 0 的时候，表示每次事务提交时不进行刷盘操作
- 1：设置为 1 的时候，表示每次事务提交时都将进行刷盘操作（默认值）
- 2：设置为 2 的时候，表示每次事务提交时都只把 redo log buffer 内容写入文件系统缓存（page cache）

`innodb_flush_log_at_trx_commit` 参数默认为 1 ，也就是说每当事务提交时会执行系统调用 `fsync` 对 redo log 进行刷盘。

另外，InnoDB 存储引擎有一个后台线程，每隔 1 秒，就会把 redo log buffer 中的内容写到文件系统缓存中，然后调用 `fsync` 刷盘，这意味着即使没有提交事务，也可能会刷盘。

![image-20220513105108191](https://fastly.jsdelivr.net/gh/Faraway002/typora/images/image-20220513105108191.png)

除此之外，当 redo log buffer 占用的空间即将达到 `innodb_log_buffer_size` 一半的时候，后台线程也会主动刷盘。
