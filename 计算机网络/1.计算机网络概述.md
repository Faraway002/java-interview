# 计算机网络概述

因特网是一个全球范围内的计算机网络，所有连接到该网络的设备称为**主机**或**端系统**，端系统通过**数据链路**和**分组交换机**连接到一起

* 数据链路：数据链路指的是因特网中两个节点之间的**物理通道**。通信链路的传输介质有双绞线、光纤和微波等等。
* 分组交换机：网络交换设备，它主要包括三个基本部分：交换单元、接口单元和控制单元。分组交换机有两种比较著名的类型：路由器和链路层交换机，它们最终的目的都是决定传输的**路径**，把分组送到目的地。

不同的链路能够以不同的速率进行传输数据，称为链路的**传输速率** ，以比特/秒（bit/s，或 bps）进行度量。当一台端系统要向另一台端系统发送数据时，发送端系统将数据分段，并为每段加上首部字节。由此形成的信息包用计算机网络的术语称为**分组（packet）**，这个分组的概念非常重要，以后我们会经常提到。这些分组通过网络发送到目的端系统，在那里被装配成初始数据。

端系统会通过**因特网服务提供商（ISP）**接入到因特网中，比如中国移动和中国电信。ISP 也有许多层次，比如国家级 ISP，这些 ISP 相互连接，联通了整个世界。数据链路的物理材质不同，传输的速率也不同。不同的 ISP 提供了不同的数据链路，因此价格也不同。

每一个连接到互联网的端系统都需要在它的计算机上运行**协议**，这是为了防止端系统不能识别接收到的分组，同时也是为了保护计算机，更重要的是，协议是计算机网络层次模型的一个重要组成部分。**协议（protocol）定义了在两个或多个通信实体之间交换报文的格式和顺序，以及报文发送和/或接受一条报文或其他事件所采取的动作**。

其中 TCP 和 IP 协议是因特网中最重要的两个协议。IP 协议定义了在路由器和端系统之间发送和接收的分组格式。因特网中的协议统称为 TCP/IP 协议簇，而不单单指的是TCP 和 IP 两个协议。

协议由操作系统和硬件共同实现，并由操作系统提供 API 给上层应用程序，应用程序通过调用这些 API，能够获得从另一个端系统传来的分组，并且能够构造一个新的分组传输回去。所以，网络实际上解决了不同设备间的进程间通信问题。

## 网络模型

由于有许多不同的端系统，协议也必然多种多样，网络模型的设计必定极为复杂，因此采取**分层**的方式设计网络更为合适。

传统的 TCP/IP 因特网网络模型中，网络被分为了五层，而更规范的 OSI 网络模型中，把网络分为了七层：

1. 应用层。应用层是 OSI 标准模型的最顶层，是**直接为应用提供服务**的。其作用是在实现多个系统应用进程相互通信的同时，完成一系列业务处理所需的服务。包括文件传输、电子邮件远程登录和远端接口调用等协议。

   我们把应用层的分组称之为**报文（Message）**。

2. 表示层。表示层向上对应用进程服务，向下接收会话层提供的服务，表示层位于 OSI 标准模型的第六层，表示层的主要作用就是将设备的固有数据格式转换为网络标准传输格式。

   五层网络模型中没有这一层。

3. 会话层。会话层位于 OSI 标准模型的第五层，它是建立在传输层之上，利用传输层提供的服务建立和维持会话。

   五层网络模型中没有这一层。

4. 运输层。传输层位于 OSI 标准模型的第四层，它在整个 OSI 标准模型中起到了至关重要的作用。**传输层涉及到两个节点之间的数据传输，向上层提供可靠的数据传输服务**。

   传输层的服务一般要经历传输连接建立阶段，数据传输阶段，传输连接释放阶段 3 个阶段才算完成一个完整的服务过程。我们通常把运输层的分组称之为**报文段（Segment）**。

5. 网络层。网络层位于 OSI 标准模型的第三层，它位于传输层和数据链路层的中间，将数据设法从源端经过若干个中间节点传送到另一端，从而**向运输层提供最基本的端到端的数据传送服务**。

   我们通常把运输层的分组称之为**数据报（Datagram）**。

6. 数据链路层。数据链路层位于物理层和网络层中间，数据链路层**定义了在单个链路上如何传输数据**。

   我们通常把数据链路层的分组称之为**帧（Frame）**。

7. 物理层。物理层是 OSI 标准模型中最低的一层，物理层是整个 OSI 协议的基础，就如同房屋的地基一样，**物理层为设备之间的数据通信提供传输媒体及互连设备，为数据传输提供可靠的环境**。

可以使用一张图概括它：

![image-20220328205316007](https://fastly.jsdelivr.net/gh/Faraway002/typora/imagesimage-20220328205316007.png)

### TCP/IP 协议簇

#### 发展历史

最初还没有 TCP/IP 协议的时候，也就是在 20 世纪 60 年代，许多国家和地区认识到通信技术的重要性。美国国防部希望能够研究一种即使通信线路被破坏也能够通过其他路线进行通信的技术。为了实现这种技术，出现了分组网络。

![image-20220328213745729](https://fastly.jsdelivr.net/gh/Faraway002/typora/imagesimage-20220328213745729.png)

即使在两个节点通信的过程中，几个节点遭到破坏，却依然能够通过改变线路等方式达使两个节点之间进行通信。

这种分组网络促进了 **ARPANET（Advanced Research Projects Agency Network）** 的诞生。ARPANET 是第一个具有分布式控制的广域包分组交换网络，也是最早实现 TCP/IP 协议的前身。

20 世纪 90 年代，开展了 OSI 这一国际标准化的进程，然而却没有取得实质性的进展，但是却使 TCP/IP 协议得到了广泛使用。

这种致使 TCP/IP 协议快速发展的原因可能是由于 TCP/IP 的标准化。也就是说 TCP/IP 协议中会涉及到 OSI 所没有的标准，而这种标准将是我们接下来主要探讨的内容。

#### TCP/IP 标准

TCP/IP 相较于其他协议的标准，更注重两点：**开放性**和**实用性**，即标准化能否被实际使用。

开放性说的是 TCP/IP 是由 IETF 讨论制定的，而 IETF 本身就是一个允许任何人加入进行讨论的组织。

实用性说的是就拿框架来说，如果只浮于理论，而没有落地的实践，那么永远成为不了主流。

TCP/IP 的标准协议就是我们所熟知的 RFC 文档，当然你可以在网络上看到。RFC 不仅规范了协议标准，还包含了协议的实现和使用信息。关于更多 RFC 协议，请参阅官方文档：[RFC](https://www.rfc-editor.org/rfc-index.html)。

#### 协议簇

我们之前说过，TCP/IP 网络模型是五层（也有的地方会说是四层），可以简单的认为会话层和表示层被合并到了应用层中（如果是四层，则物理层被合并到了数据链路层中）。

TCP/IP 协议簇涵盖了这五层，常见的协议有：

* IP 协议，是 Internet Protocol，位于网络层。**IP 是整个 TCP/IP 协议族的核心，也是构成互联网的基础**。

  IP 能够为运输层提供数据分发，同时也能够组装数据供运输层使用。它将多个单个网络连接成为一个互联网，这样能够提高网络的可扩展性，实现大规模的网络互联。二是分割顶层网络和底层网络之间的耦合关系。

* ICMP 协议，是 Internet Control Message Protocol，ICMP 协议主要用于在 IP 主机、路由器之间**传递控制消息**。

  ICMP 属于网络层的协议，当遇到 IP 无法访问目标、IP 路由器无法按照当前传输速率转发数据包时，会自动发送 ICMP 消息，从这个角度来说，ICMP 协议可以看作是**错误侦测与回报机制**，让我们检查网络状况、也能够确保连线的准确性。

* ARP 协议，是地址解析协议，即 Address Resolution Protocol，它能够根据 IP 地址**获取物理 MAC 地址**。

  主机发送信息时会将包含目标 IP 的 ARP 请求广播到局域网络上的所有主机，并接受返回消息，以此来确定物理地址。收到消息后的物理地址和 IP 地址会在 ARP 中缓存一段时间，下次查询的时候直接从 ARP 中查询即可。

* TCP 协议，是传输控制协议，也就是 Transmission Control Protocol，它是一种**面向连接的、可靠的、基于字节流的传输协议**。

  TCP 协议位于传输层，是 TCP/IP 协议簇中的核心协议，它最大的特点就是提供**可靠的数据交付**。

* UDP 协议，是用户数据报协议，也就是 User Datagram Protocol，UDP 也是一种传输层的协议，与 TCP 相比，UDP 提供一种**不可靠的数据交付**，也就是说，UDP 协议不保证数据是否到达目标节点，当报文发送之后，无法得知其是否安全完整到达的。

  UDP 是一种无连接的协议，传输数据之前源端和终端		无需建立连接，不对数据报进行检查与修改，无须等待对方的应答，会出现分组丢失、重复、乱序等现象。但是 UDP 具有较好的实时性，工作效率较 TCP 协议高。

* FTP 协议，是文件传输协议，英文全称是 File Transfer Protocol，应用层协议之一，是 TCP/IP 协议的重要组成之一，FTP 协议分为服务器和客户端两部分，FTP 服务器用来存储文件，FTP 客户端用来访问 FTP 服务器上的文件，FTP 的传输效率比较高，所以一般使用 FTP 来传输大文件。

* DNS 协议，是域名系统协议，英文全称是 Domain Name System，它也是应用层的协议之一，DNS 协议是一个将域名和 IP 相互映射的分布式数据库系统。DNS 缓存能够加快网络资源的访问。

* SMTP 协议，是简单邮件传输协议，英文全称是 Simple Mail Transfer Protocol，应用层协议之一，SMTP 主要是用作邮件收发协议，SMTP 服务器是遵循 SMTP 协议的发送邮件服务器，用来发送或中转用户发出的电子邮件

* ...

#### 分组的传输历程

本节会简单介绍一下分组是如何传输的，并不涉及特别深的原理。

我们之前讲过，每一层的分组名称都是不一样的，这是因为每一层协议需要对上一层来的分组进行包装，如下图所示：

![image-20220328214617022](https://fastly.jsdelivr.net/gh/Faraway002/typora/imagesimage-20220328214617022.png)

这个包装的部分我们称之为**首部**，包含了该层必要的信息。

##### 发送历程

* 应用层：假设用户通过 QQ 发送了一个单词 Hello 给另外一个用户，那么 Hello 这个消息就会被应用层封装为报文，然后对其进行一些处理，可能包括字符编码、格式化等。

  报文在发送的那一刻建立了 TCP 连接，这个连接相当于通道，在这之后其他数据包也会使用通道传输数据。

* 传输层：QQ 为了保证消息传达到，会使用 TCP 协议进行传输。TCP 会根据应用的指示，负责建立连接、发送数据和断开连接。

  TCP 会在应用数据层的前端附加一个 TCP 首部字段，TCP 首部包含了**源端口号**和**目的端口号**，这两个端口号用于表明数据包是从哪里发出的，需要发送到哪个应用程序上；TCP 首部还包含**序号**，用以表示该包中数据是发送端整个数据中第几个字节的序列号；TCP 首部还包含**校验和**，用于判断数据是否损坏，随后将 TCP 头部附加在数据包的首部发送给 IP。

* 网络层：主要负责处理数据包的是 IP 协议，IP 协议将 TCP 传过来的 TCP 首部和数据结合当作自己的数据，并在 TCP 首部的前端加上自己的 IP 首部。因此，IP 数据包后面会紧跟着 TCP 数据包，后面才是数据本身。

  IP 首部包含目的和源地址，紧随在 IP 首部的还有用来判断后面是 TCP 还是 UDP 的信息。

  如果不知道目标主机的 IP 地址，可以利用 **ARP（Address Resolution Protocol）**地址解析协议进行查找。

* 链路层：经由 IP 传过来的数据包，以太网会给数据附上以太网首部并进行发送处理。以太网首部包含接收端的 MAC 地址、发送端的 MAC 地址以及标志以太网类型的以太网数据协议等。

##### 接收历程

* 链路层：目标主机收到数据包后，首先会从以太网的首部找到 MAC 地址判断是否是发给自己的数据包，如果不是发给自己的数据包则会丢弃该数据包。

  如果收到的数据包是发送给自己的，就会查找以太网类型判断是哪种协议，如果是 IP 协议就会扔给 IP 协议进行处理，如果是 ARP 协议就会扔给 ARP 协议进行处理。如果协议类型是一种无法识别的协议，就会将该数据包直接丢弃。

* 网络层：经过以太网处理后的数据包扔给网络层进行处理，我们假设协议类型是 IP 协议，那么，在 IP 收到数据包后就会解析 IP 首部，判断 IP 首部中的 IP 地址是否和自己的 IP 地址匹配，如果匹配则接收数据并判断上一层协议是 TCP 还是 UDP；如果不匹配则直接丢弃。

* 传输层：在 TCP 处理过程中，首先会计算一下校验和，判断数据是否被损坏。然后检查是否按照序号接收数据，最后检查端口号，确定具体是哪个应用程序。数据被完整的识别后，会传递给由端口号识别的应用程序进行处理。

* 应用层：接收端指定的应用程序会处理发送方传递过来的数据，通过解码等操作识别出数据的内容，然后把对应的数据存储在磁盘上，返回一个保存成功的消息给发送方，如果保存失败，则返回错误消息。

##### 总结

我们发现，报文发送类似一个递归的过程，发送方从上层到下层进行层层封装，接收方从下层到上层进行层层拆解，如下图所示：

![image-20220328215516675](https://fastly.jsdelivr.net/gh/Faraway002/typora/imagesimage-20220328215516675.png)

## 网络核心

本节简述网络的一些核心机制。

### 传输方式

网络根据传输方式可以进行分类，一般分成两种 **面向连接型和面向无连接型**。

- 面向连接型中，在发送数据之前，需要在主机之间建立一条通信线路。
- 面向无连接型则不要求建立和断开连接，发送方可用于任何时候发送数据。接收端也不知道自己何时从哪里接收到数据。

### 分组交换

分组是通过链路和交换器进行传输和交换的，分组由一个个 bit 构成，假设分组的长度是 $L$ bit，链路的传输速率为 $R$ bit/s，则需要的时间为 $\frac{L}{R}$ s。

多数分组交换机都使用了**分组存储转发**的机制，即**当交换机要向下一个目的地传送分组之前，交换机需要接收到完整的分组**。如下图所示：

![image-20220328205534749](https://fastly.jsdelivr.net/gh/Faraway002/typora/imagesimage-20220328205534749.png)

当然，分组存储转发保证了整个分组的完整性，但是也会带来几个问题，比较明显的就是排队时延和丢包。

### 排队时延和丢包

多个端系统同时给交换器发送分组，一定存在顺序到达和排队的问题。

事实上，对于每条相连的链路，该分组交换机会有一个**输出缓存（output buffer）**和**输出队列（output queue）**与之对应，它用于存储路由器准备发往每条链路的分组。如果到达的分组发现路由器正在接收其他分组，那么新到达的分组就会在输出队列中进行排队，这种等待分组转发所耗费的时间也被称为**排队时延**。

当然，等待被转发的分组还承受一个存储转发时延。

事实上，网络的时延的计算公式如下：
$$
d_{total} = d_{proc} + d_{queue} + d_{trans} + d_{prop}
$$
其中，$d_{proc}$ 为分组在交换机上的处理时间（包含存储转发时延），$d_{queue}$ 为分组在交换机中的排队时延，$d_{trans}$ 为整个分组经由交换机推向链路的时间（由于分组存储转发机制，这个时间是不可忽略的），$d_{prop}$ 为分组在链路上的传输时间。		

因为队列是有容量限制的，当多条链路同时发送分组导致输出缓存无法接受超额的分组后，这些分组会丢失，这种情况被称为**丢包（packet loss）**，到达的分组或者已排队的分组将会被丢弃。这种情况下，排队时延是无限大的。

> **流量强度**
>
> 如果用 a 表示分组到达队列的平均速率（a 的单位是分组/秒，即 pkt/s），前面说过 R 表示的是传输速率，所以能够从队列中推出比特的速率（以 bps 即 b/s 位单位）。假设所有的分组都是由 L 比特组成的，那么比特到达队列的平均速率是 La bps。那么比率 $\frac{La}{R}$ 被称为**流量强度**，**如果流量强度 > 1，则比特到达队列的平均速率超过从队列传输出去的速率，这种情况下队列趋向于无限增加，最后就会导致丢包**。
>
> 所以，**设计系统时流量强度不能大于1**。
>
> 现在考虑流量强度 <= 1 时的情况，**流量到达的性质将影响排队时延**。如果流量是**周期性**到达的，即每 $\frac{L}{R}$ 秒到达一个分组，则每个分组将到达一个空队列中，不会有排队时延。如果流量是**突发性**到达的，则可能会有很大的平均排队时延。一般可以用下面这幅图表示平均排队时延与流量强度的关系：
>
> ![image-20220328210503911](https://fastly.jsdelivr.net/gh/Faraway002/typora/imagesimage-20220328210503911.png)

### 吞吐量

考虑从主机 A 到主机 B 跨越计算机网络传送一个大文件，在任何瞬间的**瞬时吞吐量**是主机 B 接收到该文件的速率，单位是 bps。而**平均吞吐量**则是整个文件的大小比上接收到整个文件的时间。吞吐量也就是我们平常说的网速。

考虑这样一个计算机网络：

![image-20220118110723791](https://fastly.jsdelivr.net/gh/Faraway002/typora/imagesimage-20220118110723791.png)

其中 $R_{i}$ 为每一条线路的最大吞吐量，整个网络的最大吞吐量就为：$min(R_1, R_2, ..., R_i)$

### 单播、广播、多播和任播

在网络通信中，可以根据目标地址的数量对通信进行分类，可以分为 **单播、广播、多播和任播**。

* 单播：单播最大的特点就是 1 对 1，早期的固定电话就是单播的一个例子。

* 广播：1 对多，主机向其他所有的端系统发送。

* 多播：也是 1 对多，类似于广播，但是需要限定具体的某一组主机作为接收端。

* 任播：任播是在特定的多台主机中选出一个接收端。

  虽然和多播很相似，但是行为与多播不同，任播是从许多目标机群中选出一台最符合网络条件的主机作为目标主机发送消息。然后被选中的特定主机将返回一个单播信号，然后再与目标主机进行通信。
