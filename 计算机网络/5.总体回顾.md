# 总体回顾

本节将使用一个问题，带领大家回顾整个计算机网络的知识。

问题：一名学生小明将他的 PC 与学校的以太网交换机相连，请求一个  Web 页面（www.baidu.com），问这个过程中涉及到哪些网络的知识？

整个网路结构如下图所示：

<img src="https://cdn.jsdelivr.net/gh/Faraway002/typora/images/image-20220711225442468.png" alt="image-20220711225442468" style="zoom: 80%;" />

## 1. 准备：DHCP、UDP、IP 和以太网

我们假定小明启动他的 PC，然后将其用一根网线连接到学校的以太网交换机，交换机又与学校的路由器相连，路由器又与一个 ISP 连接,，本例中 ISP 为 comcast.net，在本例中，comcast.net 为学校提供了 DNS 服务；所以，DNS 服务器驻留在 comcast 网络中而不是学校网络中。我们将假设 DHCP 服务器运行在路由器 中，就像常见情况那样。 

当小明首先将其 PC 与网络连接时，没有 IP 地址他就不能做任何事情。所以，小明的 PC 所采取的第一个动作就是运行 DHCP 协议，以从 DHCP 服务器**获得一个 IP 地址以及其他信息**。 

1. 小明 PC 上的操作系统生成一个 **DHCP 请求报文**，并将这个报文放入具有目的端口 67 （DHCP 服务器）和源端口 68 （DHCP 客户段）的 UDP 报文段，该UDP 报文段则被放置在一个具有广播 IP 目的地址（255.255.255.255）和源 IP 地址 0.0.0.0 的 IP 数据报中。

2. 包含 DHCP 请求报文的 IP 数据报则被**放置在以太网帧中**。该以太网帧具有目的 MAC 地址 FF:FF:FF:FF:FF:FF，使该帧将广播到与交换机连接的所有设备（如果顺利的话也包括 DHCP 服务器）；该帧的源 MAC 地址是小明 PC 的 MAC 地址 00:16:D3:23:68:8A。

3. 包含 DHCP 请求的广播以太网帧是第一个由小明的 PC发送到以太网交换机的帧。**该交换机在所有的出端口广播入帧**，包括连接到路由器的端口。

4. 路由器在它的具有 MAC 地址 00:22:6B:45:1F:1B 的接口接收到该广播以太网帧，该帧中包含 DHCP 请求，并且**从该以太网帧中抽取出 IP 数据报**。该数据报的广播 IP 目的地址指示了这个 IP 数据报应当由在该节点的高层协议处理，因此**该数据报的载荷（一个 UDP 报文段）被分解向上到达 UDP，DHCP 请求报文从此 UDP 报文段中抽取出来**。此时 DHCP 服务器有了 DHCP 请求报文。

5. 我们假设运行在路由器中的 DHCP 服务器能够以 CIDR 的方式分配 IP 地址，由于地址块是 68.85.2.0/24，我们假设 DHCP 服务器分配地址 68.85.2.101 给小明的 PC。DHCP 服务器生成包含这个 IP 地址以及 DNS 服务器的 IP 地址（68.87.71.226）、默认网关路由器的 IP 地址（68.85.2.1）和子网块（68.85.2.0/24）的一个 **DHCP ACK 报文**。

   该 DHCP 报文被放入一个 UDP 报文段中，UDP 报文段被放入一个 IP 数据报中，IP 数据报再被放入一个以太网帧中。这个以太网帧的源 MAC 地址是路由器连到归属网络时接口的 MAC 地址（00:22:6B:45:1F:1B），目的 MAC 地址是小明 PC 的 MAC 地 址（00:16:D3:23:68:8A）。

6. **包含 DHCP ACK 的以太网帧由路由器发送给交换机**。因为交换机是自学习的 ，并且先前从小明的 PC 处收到包含 DHCP 请求的以太网帧，所以该交换机知道寻址到 00:16:D3:23:68:8A 的帧仅从通向小明的 PC 的输岀端口转发。 

7. 小明的 PC 接收到包含 DHCP ACK 的以太网帧，从该以太网帧中抽取 IP 数据报，从 IP 数据报中抽取 UDP 报文段，从 UDP 报文段抽取 DHCP ACK 报文。

   小明的 PC 的 DHCP 客户端则记录下它的 IP 地址和它的 DNS 服务器的 IP 地址，它还在其 IP 转发表中安装默认网关的地址。

   小明的 PC 将向该默认网关发送目的地址为其子网 68. 85. 2. 0/24 以外的所有数据报。此时，小明的 PC 已经初始化好它的网络组件，并准备开始处理 Web 网页获取。

## 2. 准备：DNS 和 ARP

当小明将 www.baidu.com 的 URL 键入其 Web 浏览器时，他开启了一长串事件，这将导致百度的主页最终显示在其 Web 浏览器上。

小明的 Web 浏览器通过生成一个 TCP 套接字开始了该过程，套接字用于向 www.baidu.com 发送 HTTP 请求。为了生成该套接字，小明的 PC 需要知道 www.baidu.com 的 IP 地址。我们在之前学过，使用 DNS 协议提供这种名字到 IP 地址的转换服务。 

8. 小明 PC 机上的操作系统因此**生成一个 DNS 查询报文**，将 www.baidu.com 放入 DNS 报文的问题段中。该 DNS 报文则放置在一个具有 53 号目的端口（DNS 服务器）的 UDP 报文段中。该 UDP 报文段则被放入具有 IP 目的地址 68.87.71.226 （第 5 步中 DHCP ACK 返回的 DNS 服务器地址）和源 IP 地址68.85.2.101 的 IP 数据报中。

9. 小明 PC 机则将包含 DNS 请求报文的数据报放入一个以太网帧中该帧将发送到小明学校网络中的网关路由器。

   然而，即使 小明 PC 机经过上述第 5 步中的 DHCP ACK 报文知道了学校网关路由器的 IP 地址，但仍不知道该网关路由器的 MAC 地址。为了获得该网关路由器的 MAC 地址，小明 PC 机将需要**使用 ARP 协议**。

10. 小明 PC 机生成一个具有目的 IP 地址 68.85.2.1（默认网关）的 **ARP 查询报文**，将该 ARP 报文放置在一个具有广播目的地址（FF:FF:FF:FF:FF:FF）的以太网帧中，并向交换机发送该以太网帧，交换机将该帧交付给所有连接的设备，包括网关路由器。

11. 网关路由器在通往学校网络的接口上接收到包含该 ARP 查询报文的帧，发现在 ARP 报文中目标 IP 地址 68.85.2.1 匹配其接口的 IP 地址。网关路由器因此准备一个 **ARP 回答**，指示它的 MAC 地址 00:22:6B:45:1F:1B 对应 IP 地址 68.85.2.1。

    它将 ARP 回答放 在一个以太网帧中，其目的地址为 00:16:D3:23:68:8A（小明 PC 机），并向交换机发送该帧，再由交换机将帧交付给小明 PC 机。

12. 小明 PC 机接收包含 ARP 回答报文的帧，并**从 ARP 回答报文中抽取网关路由器的 MAC 地址**。

13. 小明 PC 机现在能够使包含 DNS 查询的以太网帧寻址到网关路由器的 MAC 地址，现在，该帧被小明的 PC 机发送到网关路由器上。

## 3. 准备：域内路由选择和 DNS

14. 网关路由器接收该帧并抽取包含 DNS 查询的 IP 数据报。路由器查找该数据报的目的地址（68.87.71.226），并根据其转发表决定该数据报应当发送到 comcast 网络中最左边的路由器。

    IP 数据报放置在链路层帧中，该链路适合将学校路由器连接到最左边的 comcast 路由器，并且该帧经这条链路发送。

15. 在 comcast 网络中最左边的路由器接收到该帧，抽取 IP 数据报，检查该数据报的目的地址（68.87.71.226），并根据其转发表确定出接口，经过该接口朝着DNS 服务器转发数据报，而转发表已根据 comcast 的域内协议（如 OSPF）以及因特网的域间协议 BGP 所填写。

16. 最终**包含 DNS 查询的 IP 数据报到达了 DNS 服务器**。DNS 服务器抽取出 DNS 查询报文，在它的 DNS 数据库中查找名字 www.baidu.com，找到包含对应 www.baidu.com 的 IP 地址（64.233.169.105）的 DNS 源记录。

    > 本节忽略了 DNS 的层次级别，一般来说是先到本地 DNS 服务器，如果没查到再到根 DNS 服务器，然后就是顶级域名 DNS 服务器，权威 DNS 服务器...

    该 DNS 服务器形成了一个包含这种主机名到 IP 地址映射的 **DNS 回答报文**，将该 DNS 回答报文放入 UDP 报文段中，该报文段放入寻址到小明 PC 机的 IP 数据报中。 

    该数据报将通过 comcast 网络反向转发到学校的路由器，并从这里经过以太网交换机到小明的 PC 机上。

17. 小明的 PC 机从 DNS 报文抽取出服务器 www.baidu.com 的 IP 地址。最终，在大量工作后，小明的 PC 机此时准备接触 www.baidu.com 的服务器。

## 4. TCP 和 HTTP

18. 既然小明 PC 机有了 www.baidu.com 的 IP 地址，它能够生成 TCP 套接字，该套接字将用于向 www.baidu.com 发送 HTTP GET 报文。

    当小明生成 TCP 套接字时，在小明 PC 中的 TCP 必须首先与 www.baidu.com 中的 TCP 执行三次握手。

    小明 PC 因此首先生成一个具有目的端口 80（针对 HTTP 的）的 TCP SYN 报文段，将该 TCP 报文段放置在具有目的 IP 地址 64.233.169.105 （www.baidu.com）的 IP 数据报中，将该数据报放置在以太网帧中，并向交换机发送该帧。

19. 在学校网络、comcast 网络和百度网络中的路由器朝着 www.baidu.com 转发包含 TCP SYN 的数据报，使用每台路由器中的转发表，如前面步骤 14〜16 那样。

20. 最终，包含 TCP SYN 的数据报到达 www.baidu.com。从数据报抽取出 TCP SYN 报文并分解到与端口 80 相联系的欢迎套接字。对于百度 HTTP 服务器和小明 PC 之间的 TCP 连接生成一个连接套接字。产生一个 TCP SYN-ACK 报文段，将其放入向小明 PC 机寻址的一个数据报中，最后放入链路层帧中，该链路适合将 www.baidu.com 连接到其第一跳路由器。

21. 包含 TCP SYN-ACK 报文段的数据报通过百度、comcast 和学校网络，最终到达小明 PC 机的以太网卡。数据报在操作系统中分解到步骤 18 生成的 TCP 套接字，从而进入连接状态。

22. 借助于小明 PC 机上的套接字，现在准备向 www.baidu.com 发送字节了，小明的浏览器生成包含要获取的 URL 的 HTTP GET 报文。HTTP GET 报文则写入套接字，其中 GET 报文成为一个 TCP 报文段的载荷。该 TCP 报文段放置进一个数据报中，并交付到 www.baidu.com，如前面步骤 18-20 所述。

23. 在 www.baidu.com 的 HTTP 服务器从 TCP 套接字读取 HTTP GET 报文，生成一个 HTTP 响应报文，将请求的 Web 页内容放入 HTTP 响应体中，并将报文发送进 TCP 套接字中。

24. 包含 HTTP 响应报文的数据报通过百度、comcast 和学校网络转发，到达小明 PC 机。小明的 Web 浏览器程序从套接字读取 HTTP 响应，从 HTTP 响应体中抽取 Web 网页的 HTML，并最终显示了 Web 网页。