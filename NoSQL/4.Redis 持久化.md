# Redis 持久化

Redis 是内存型数据库，为了保证数据在宕机后不会丢失，需要将内存中的数据持久化到硬盘上。

Redis 支持两种持久化方式：RDB 和 AOF。

- RDB：RDB 即快照方式，它将某个时间点的所有 Redis 数据保存到一个经过压缩的二进制文件（RDB 文件）中**。
- AOF：AOF（Append Only File）是以文本日志形式将所有写命令追加到 AOF 文件的末尾，以此来记录数据的变化。当服务器重启的时候会重新载入和执行这些命令来恢复原始的数据。AOF 适合作为**热备**。

## RDB

**RDB 即快照方式，它将某个时间点的所有 Redis 数据保存到一个经过压缩的二进制文件（RDB 文件）中**。

创建 RDB 后，用户可以对 RDB 进行**备份**，可以将 RDB **复制**到其他服务器从而创建具有相同数据的服务器副本，还可以在**重启**服务器时使用。一句话来说：RDB 适合作为**冷备**。

RDB 既可以手动执行，也可以根据服务器配置选项定期执行。该功能可以将某个时间点的数据库状态保存到一个 RDB 文件中。

优点：

- RDB 文件非常紧凑，**适合作为冷备**。比如你可以在每个小时报保存一下过去 24 小时内的数据，同时每天保存过去 30 天的数据，这样即使出了问题你也可以根据需求恢复到不同版本的数据集。
- 快照在保存 RDB 文件时父进程唯一需要做的就是 fork 出一个子进程，接下来的工作全部由子进程来做，父进程不需要再做其他 IO 操作，所以快照持久化方式可以最大化 Redis 的性能。
- **恢复大数据集时，RDB 比 AOF 更快**。

缺点：

- **如果系统发生故障，将会丢失最后一次创建快照之后的数据**。如果你希望在 Redis 意外停止工作（例如电源中断）的情况下丢失的数据最少的话，那么快照不适合你。虽然你可以配置不同的 save 时间点(例如每隔 5 分钟并且对数据集有 100 个写的操作)，是 Redis 要完整的保存整个数据集是一个比较繁重的工作，你通常会每隔 5 分钟或者更久做一次完整的保存，万一在 Redis 意外宕机，你可能会丢失几分钟的数据。
- **如果数据量很大，保存快照的时间会很长**。快照需要经常 fork 子进程来保存数据集到硬盘上。当数据集比较大的时候，fork 的过程是非常耗时的，可能会导致 Redis 在一些毫秒级内不能响应客户端的请求。如果数据集巨大并且 CPU 性能不是很好的情况下，这种情况会持续 1 秒。AOF 也需要 fork，但是你可以调节重写日志文件的频率来提高数据集的耐久度。

### RDB 创建

有两个 Redis 命令可以用于生成 RDB 文件：`SAVE` 和 `BGSAVE`。

- `SAVE`命令会阻塞 Redis 服务器进程，直到 RDB 创建完成为止，在阻塞期间，服务器不能响应任何命令请求。

- `BGSAVE` 命令会派生出（fork）一个子进程，然后由子进程负责创建 RDB 文件，服务器进程（父进程）继续处理命令请求。

  `BGSAVE` 命令执行期间，`SAVE`、`BGSAVE`、`BGREWRITEAOF` 三个命令会被拒绝，以免与当前的 `BGSAVE` 操作产生竞态条件，降低性能。

### 自动间隔保存

Redis 允许用户通过设置服务器配置的 `save` 选项，让服务器每隔一段时间自动执行一次 `BGSAVE` 命令。

用户可以通过 `save` 选项设置多个保存条件，但只要其中任意一个条件被满足，服务器就会执行 `BGSAVE` 命令。

举例来说，`redis.conf` 中设置了如下配置：

```text
save 900 1       -- 900 秒内，至少对数据库进行了 1 次修改
save 300 10      -- 300 秒内，至少对数据库进行了 10 次修改
save 60 10000    -- 60 秒内，至少对数据库进行了 10000 次修改
```

只要满足以上任意条件，Redis 服务就会执行 BGSAVE 命令。

### RDB 的载入

**RDB 文件的载入工作是在服务器启动时自动执行的**，Redis 并没有专门用于载入 RDB 文件的命令。

服务器载入 RDB 文件期间，会一直处于阻塞状态，直到载入完成为止。

### RDB 的文件结构

RDB 文件是一个经过压缩的二进制文件，由多个部分组成。

对于不同类型（STRING、HASH、LIST、SET、SORTED SET）的键值对，RDB 文件会使用不同的方式来保存它们。

![img](https://cdn.jsdelivr.net/gh/Faraway002/typora/images/redis-rdb-structure.png)

Redis 本身提供了一个 RDB 文件检查工具 redis-check-dump。

## AOF

AOF（Append Only File） 是以 **文本日志形式**将**所有写命令以 Redis 命令请求协议格式追加到 AOF 文件的末尾**，以此来记录数据的变化。**当服务器重启时，会重新载入和执行 AOF 文件中的命令，就可以恢复原始的数据**。AOF 适合作为**热备**。

AOF 可以通过 `appendonly yes` 配置选项来开启。

命令请求会先保存到 AOF 缓冲区中，之后再定期写入并同步到 AOF 文件。

优点：

- **如果系统发生故障，AOF 丢失数据比 RDB 少**。你可以使用不同的 fsync 策略：无 fsync；每秒 fsync；每次写的时候 fsync。使用默认的每秒 fsync 策略，Redis 的性能依然很好(fsync 是由后台线程进行处理的,主线程会尽力处理客户端请求)，一旦出现故障，你最多丢失 1 秒的数据。
- **AOF 文件可修复**。AOF 文件是一个只进行追加的日志文件，所以不需要写入 seek，即使由于某些原因(磁盘空间已满，写的过程中宕机等等)未执行完整的写入命令，你也也可使用 redis-check-aof 工具修复这些问题。
- **AOF 文件可压缩**。Redis 可以在 AOF 文件体积变得过大时，自动地在后台对 AOF 进行重写：重写后的新 AOF 文件包含了恢复当前数据集所需的最小命令集合。整个重写操作是绝对安全的，因为 Redis 在创建新 AOF 文件的过程中，会继续将命令追加到现有的 AOF 文件里面，即使重写过程中发生停机，现有的 AOF 文件也不会丢失。而一旦新 AOF 文件创建完毕，Redis 就会从旧 AOF 文件切换到新 AOF 文件，并开始对新 AOF 文件进行追加操作。
- **AOF 文件可读**。AOF 文件有序地保存了对数据库执行的所有写入操作，这些写入操作以 Redis 命令的格式保存。因此 AOF 文件的内容非常容易被人读懂，对文件进行分析（parse）也很轻松。 导出（export） AOF 文件也非常简单。举个例子，如果你不小心执行了 FLUSHALL 命令，但只要 AOF 文件未被重写，那么只要停止服务器，移除 AOF 文件末尾的 FLUSHALL 命令，并重启 Redis ，就可以将数据集恢复到 FLUSHALL 执行之前的状态。

缺点：

- **AOF 文件体积一般比 RDB 大**：对于相同的数据集来说，AOF 文件的体积通常要大于 RDB 文件的体积。
- **恢复大数据集时，AOF 比 RDB 慢**：根据所使用的 fsync 策略，AOF 的速度可能会慢于快照。在一般情况下，每秒 fsync 的性能依然非常高，而关闭 fsync 可以让 AOF 的速度和快照一样快，即使在高负荷之下也是如此。不过在处理巨大的写入载入时，快照可以提供更有保证的最大延迟时间（latency）。