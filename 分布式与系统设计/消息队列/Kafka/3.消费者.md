[TOC]

# 消费者

与生产者对应的是消费者，应用程序可以通过 `KafkaConsumer` 来订阅主题，并从订阅的主题中拉取消息。

## 1. 消费者与消费者组

**消费者（Consumer）负责订阅 Kafka 中的主题（Topic），并且从订阅的主题上拉取消息**。

与其他一些消息中间件不同的是，在 Kafka 的消费理念中还有一层消费者组（ConsunmerGroup）的概念：**每个消费者都有一个对应的消费者组，当消息发布到主题后，只会被投递给订阅它的每个消费组中的一个消费者**。

如下图所示：

![image-20220727084457177](https://cdn.jsdelivr.net/gh/Faraway002/typora/images/image-20220727084457177.png)

如图所示，某个主题中共有 4 个分区（Partition）：P0、P1、P2、P3。有两个消费组 A 和 B 都订阅了这个主题，消费组 A 中有 4 个消费者（C0、C1、C2 和 C3），消费组 B 中有2个消费者（C4 和 C5）。

按照 Kafka 默认的规则，最后的分配结果是消费者组 A 中的每一个消费者分配到 1 个分区，消费者组 B 中的每一个消费者分配到 2 个分区，两个消费者组之间互不影响。

**每个消费者只能消费所分配到的分区中的消息，换言之，每一个分区只能被一个消费者组中的一个消费者所消费**。

我们再来看一下消费组内的消费者个数变化时所对应的分区分配的演变。假设目前某消费组内只有一个消费者 C0，订阅了一个主题，这个主题包含 7 个分区：P0、P1、P2、P3、P4、P5、P6。也就是说，这个消费者 C0 订阅了 7 个分区，具体分配情形如下图：

![image-20220727090411848](https://cdn.jsdelivr.net/gh/Faraway002/typora/images/image-20220727090411848.png)

此时消费组内又加入了一个新的消费者 C1，按照既定的逻辑，需要将原来消费者 C0 的部分分区分配给消费者 C1 消费，如图所示：

![image-20220727090431072](https://cdn.jsdelivr.net/gh/Faraway002/typora/images/image-20220727090431072.png)

消费者 C0 和 C1 各自负责消费所分配到的分区，彼此之间并无逻辑上的干扰。

紧接着消费组内又加入了一个新的消费者 C2，消费者 C0、C1 和 C2 按照下图中的方式各自负责消费所分配到的分区：

![image-20220727090530626](https://cdn.jsdelivr.net/gh/Faraway002/typora/images/image-20220727090530626.png)

消费者与消费组这种模型可以让整体的消费能力具备**横向伸缩性**，我们可以增加（或减少）消费者的个数来提高（或降低）整体的消费能力。

**对于分区数固定的情况，一味地增加消费者并不会让消费能力一直得到提升**，如果消费者过多，出现了消费者的个数大于分区个数的情况，就会有**消费者分配不到任何分区**。如下图所示：

![image-20220727090621593](https://cdn.jsdelivr.net/gh/Faraway002/typora/images/image-20220727090621593.png)

以上分配逻辑都是基于**默认的分区分配策略**进行分析的，可以通过消费者客户端参数 `partition.assignment.strategy` 来设置消费者与订阅主题之间的分区分配策略，有关分区分配的更多细节我们之后再详细讲述。

## 2. 客户端开发